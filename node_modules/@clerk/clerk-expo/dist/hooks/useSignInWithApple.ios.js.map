{"version":3,"sources":["../../src/hooks/useSignInWithApple.ios.ts"],"sourcesContent":["import { useSignIn, useSignUp } from '@clerk/clerk-react';\nimport type { SetActive, SignInResource, SignUpResource } from '@clerk/types';\n\nimport { errorThrower } from '../utils/errors';\n\nexport type StartAppleAuthenticationFlowParams = {\n  unsafeMetadata?: SignUpUnsafeMetadata;\n};\n\nexport type StartAppleAuthenticationFlowReturnType = {\n  createdSessionId: string | null;\n  setActive?: SetActive;\n  signIn?: SignInResource;\n  signUp?: SignUpResource;\n};\n\n/**\n * Hook for native Apple Authentication on iOS using expo-apple-authentication.\n *\n * This hook provides a simplified way to authenticate users with their Apple ID\n * using the native iOS Sign in with Apple UI. The authentication flow automatically\n * handles the ID token exchange with Clerk's backend and manages the transfer flow\n * between sign-in and sign-up.\n *\n * @example\n * ```tsx\n * import { useSignInWithApple } from '@clerk/clerk-expo';\n * import { Button } from 'react-native';\n *\n * function AppleSignInButton() {\n *   const { startAppleAuthenticationFlow } = useSignInWithApple();\n *\n *   const onPress = async () => {\n *     try {\n *       const { createdSessionId, setActive } = await startAppleAuthenticationFlow();\n *\n *       if (createdSessionId && setActive) {\n *         await setActive({ session: createdSessionId });\n *       }\n *     } catch (err) {\n *       console.error('Apple Authentication error:', err);\n *     }\n *   };\n *\n *   return <Button title=\"Sign in with Apple\" onPress={onPress} />;\n * }\n * ```\n *\n * @requires expo-apple-authentication - Must be installed as a peer dependency\n * @platform iOS - This is the iOS-specific implementation\n *\n * @returns An object containing the `startAppleAuthenticationFlow` function\n */\nexport function useSignInWithApple() {\n  const { signIn, setActive, isLoaded: isSignInLoaded } = useSignIn();\n  const { signUp, isLoaded: isSignUpLoaded } = useSignUp();\n\n  async function startAppleAuthenticationFlow(\n    startAppleAuthenticationFlowParams?: StartAppleAuthenticationFlowParams,\n  ): Promise<StartAppleAuthenticationFlowReturnType> {\n    if (!isSignInLoaded || !isSignUpLoaded) {\n      return {\n        createdSessionId: null,\n        signIn,\n        signUp,\n        setActive,\n      };\n    }\n\n    // Dynamically import expo-apple-authentication only when needed\n    let AppleAuthentication;\n    let Crypto;\n\n    try {\n      [AppleAuthentication, Crypto] = await Promise.all([import('expo-apple-authentication'), import('expo-crypto')]);\n    } catch {\n      return errorThrower.throw(\n        'expo-apple-authentication is required to use Sign in with Apple. ' +\n          'Please install it by running: npx expo install expo-apple-authentication expo-crypto',\n      );\n    }\n\n    // Check if Apple Authentication is available on the device\n    const isAvailable = await AppleAuthentication.isAvailableAsync();\n    if (!isAvailable) {\n      return errorThrower.throw('Apple Authentication is not available on this device.');\n    }\n\n    try {\n      // Generate a cryptographically secure nonce for the Apple Sign-In request (required by Clerk)\n      const nonce = Crypto.randomUUID();\n\n      // Request Apple authentication with requested scopes\n      const credential = await AppleAuthentication.signInAsync({\n        requestedScopes: [\n          AppleAuthentication.AppleAuthenticationScope.FULL_NAME,\n          AppleAuthentication.AppleAuthenticationScope.EMAIL,\n        ],\n        nonce,\n      });\n\n      // Extract the identity token from the credential\n      const { identityToken } = credential;\n\n      if (!identityToken) {\n        return errorThrower.throw('No identity token received from Apple Sign-In.');\n      }\n\n      // Create a SignIn with the Apple ID token strategy\n      await signIn.create({\n        strategy: 'oauth_token_apple',\n        token: identityToken,\n      });\n\n      // Check if we need to transfer to SignUp (user doesn't exist yet)\n      const userNeedsToBeCreated = signIn.firstFactorVerification.status === 'transferable';\n\n      if (userNeedsToBeCreated) {\n        // User doesn't exist - create a new SignUp with transfer\n        await signUp.create({\n          transfer: true,\n          unsafeMetadata: startAppleAuthenticationFlowParams?.unsafeMetadata,\n        });\n\n        return {\n          createdSessionId: signUp.createdSessionId,\n          setActive,\n          signIn,\n          signUp,\n        };\n      }\n\n      // User exists - return the SignIn session\n      return {\n        createdSessionId: signIn.createdSessionId,\n        setActive,\n        signIn,\n        signUp,\n      };\n    } catch (error: unknown) {\n      // Handle Apple Authentication errors\n      if (error && typeof error === 'object' && 'code' in error && error.code === 'ERR_REQUEST_CANCELED') {\n        // User canceled the sign-in flow\n        return {\n          createdSessionId: null,\n          setActive,\n          signIn,\n          signUp,\n        };\n      }\n\n      // Re-throw other errors\n      throw error;\n    }\n  }\n\n  return {\n    startAppleAuthenticationFlow,\n  };\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yBAAqC;AAGrC,oBAA6B;AAkDtB,SAAS,qBAAqB;AACnC,QAAM,EAAE,QAAQ,WAAW,UAAU,eAAe,QAAI,8BAAU;AAClE,QAAM,EAAE,QAAQ,UAAU,eAAe,QAAI,8BAAU;AAEvD,iBAAe,6BACb,oCACiD;AACjD,QAAI,CAAC,kBAAkB,CAAC,gBAAgB;AACtC,aAAO;AAAA,QACL,kBAAkB;AAAA,QAClB;AAAA,QACA;AAAA,QACA;AAAA,MACF;AAAA,IACF;AAGA,QAAI;AACJ,QAAI;AAEJ,QAAI;AACF,OAAC,qBAAqB,MAAM,IAAI,MAAM,QAAQ,IAAI,CAAC,OAAO,2BAA2B,GAAG,OAAO,aAAa,CAAC,CAAC;AAAA,IAChH,QAAQ;AACN,aAAO,2BAAa;AAAA,QAClB;AAAA,MAEF;AAAA,IACF;AAGA,UAAM,cAAc,MAAM,oBAAoB,iBAAiB;AAC/D,QAAI,CAAC,aAAa;AAChB,aAAO,2BAAa,MAAM,uDAAuD;AAAA,IACnF;AAEA,QAAI;AAEF,YAAM,QAAQ,OAAO,WAAW;AAGhC,YAAM,aAAa,MAAM,oBAAoB,YAAY;AAAA,QACvD,iBAAiB;AAAA,UACf,oBAAoB,yBAAyB;AAAA,UAC7C,oBAAoB,yBAAyB;AAAA,QAC/C;AAAA,QACA;AAAA,MACF,CAAC;AAGD,YAAM,EAAE,cAAc,IAAI;AAE1B,UAAI,CAAC,eAAe;AAClB,eAAO,2BAAa,MAAM,gDAAgD;AAAA,MAC5E;AAGA,YAAM,OAAO,OAAO;AAAA,QAClB,UAAU;AAAA,QACV,OAAO;AAAA,MACT,CAAC;AAGD,YAAM,uBAAuB,OAAO,wBAAwB,WAAW;AAEvE,UAAI,sBAAsB;AAExB,cAAM,OAAO,OAAO;AAAA,UAClB,UAAU;AAAA,UACV,gBAAgB,yFAAoC;AAAA,QACtD,CAAC;AAED,eAAO;AAAA,UACL,kBAAkB,OAAO;AAAA,UACzB;AAAA,UACA;AAAA,UACA;AAAA,QACF;AAAA,MACF;AAGA,aAAO;AAAA,QACL,kBAAkB,OAAO;AAAA,QACzB;AAAA,QACA;AAAA,QACA;AAAA,MACF;AAAA,IACF,SAAS,OAAgB;AAEvB,UAAI,SAAS,OAAO,UAAU,YAAY,UAAU,SAAS,MAAM,SAAS,wBAAwB;AAElG,eAAO;AAAA,UACL,kBAAkB;AAAA,UAClB;AAAA,UACA;AAAA,UACA;AAAA,QACF;AAAA,MACF;AAGA,YAAM;AAAA,IACR;AAAA,EACF;AAEA,SAAO;AAAA,IACL;AAAA,EACF;AACF;","names":[]}